# 产品需求文档：AI 文档差异助手 (AI Diff Assistant) - V1.0

## 1. 综述 (Overview)

### 1.1 项目背景与核心问题
在版本迭代、合同审阅或代码审查场景中，用户常需要对比两个文档的差异。传统的 Diff 工具（如 Beyond Compare）侧重于字符级对比，难以快速提炼“语义变化”（如条款变更意图、逻辑修改）。本产品旨在打造一款**原生集成于 Windows 资源管理器**的轻量级效率工具，通过 AI 能力提供语义级的差异总结，最大化提升办公效率。

### 1.2 核心业务流程 / 用户旅程地图
1.  **阶段一：配置中心 (Configuration Hub)** - 用户进行“一次性”设置，配置 AI 服务（API/本地）并将软件注册到 Windows 右键菜单。
2.  **阶段二：右键静默执行 (Silent Execution)** - 用户在日常工作中，选中两个文件右键触发分析，软件在后台自动截断、对比，并将结果追加写入当前目录的 `difference.md`，最后通过系统通知告知结果。

## 2. 用户故事详述 (User Stories)

### 阶段一：配置中心 (Configuration Hub)

---

#### **US-01: AI 连接配置与提示词设定**
*   **价值陈述 (Value Statement)**:
    *   **作为** 用户
    *   **我希望** 灵活配置 OpenAI 兼容接口或本地 Ollama 服务，并自定义 System Prompt
    *   **以便于** 掌控 AI 的回答风格，并确保软件能连通我所使用的模型服务
*   **业务规则与逻辑 (Business Logic)**:
    1.  **输入字段**: 包含 `Base URL` (默认提示 `https://api.openai.com/v1`), `API Key` (掩码显示), `Model Name`, `System Prompt`。
    2.  **默认 Prompt**: *“你是一个文档对比助手，请对比两份文档，忽略格式差异，重点总结语义上的变化，并用 Markdown 列表输出。”*
    3.  **连接测试**: 点击“测试连接”发送简短请求，验证配置有效性。
    4.  **配置持久化**: 保存配置至本地配置文件。
*   **页面布局线框图 (ASCII Wireframe)**:
    ```text
    +---------------------------------------------------------------+
    |  AI 文档差异助手 - 配置中心                         [ _ ] [ X ] |
    +---------------------------------------------------------------+
    |                                                               |
    |  [ AI 服务设置 ]                                              |
    |  Base URL:    [ https://api.openai.com/v1                   ] |
    |  API Key:     [ ************************* ] [显示]            |
    |  Model Name:  [ gpt-4o                                      ] |
    |                                                               |
    |  -----------------------------------------------------------  |
    |                                                               |
    |  [ 提示词设置 (System Prompt) ]                               |
    |  +---------------------------------------------------------+  |
    |  | 你是一个文档对比助手，请对比两份文档，忽略格式差异，    |  |
    |  | 重点总结语义上的变化，并用 Markdown 列表输出...         |  |
    |  +---------------------------------------------------------+  |
    |             [ 测试连接 ]            [ 保存配置 ]              |
    |                                                               |
    |  -----------------------------------------------------------  |
    |                                                               |
    |  [ 系统集成 ]                                                 |
    |  当前状态: [ 未集成 ]                                         |
    |  [ 添加到右键菜单 ]           [ 从右键移除 ]                  |
    |  * 提示: 注册后，按住 Ctrl 选中两个文件即可使用。             |
    +---------------------------------------------------------------+
    ```

#### **US-02: 右键菜单注册与集成**
*   **价值陈述 (Value Statement)**:
    *   **作为** 用户
    *   **我希望** 一键将软件功能添加到 Windows 右键菜单
    *   **以便于** 在文件管理器中随时调用，无需手动打开软件
*   **业务规则与逻辑 (Business Logic)**:
    1.  **注册注册表**: 点击“添加”按钮，修改注册表 `HKCU\Software\Classes\*\shell`，添加项 `AI 差异分析`。
    2.  **命令参数**: 注册的命令需支持接收 `%1` 参数（文件路径）。
    3.  **状态反馈**: 界面需实时刷新显示当前是否已集成。
*   **验收标准 (Acceptance Criteria)**:
    *   **GIVEN** 软件未集成 **WHEN** 点击“添加到右键菜单” **THEN** 提示成功，且右键文件可见选项。

---

### 阶段二：右键静默执行 (Silent Execution)

---

#### **US-03: 静默启动与智能分析逻辑**
*   **价值陈述 (Value Statement)**:
    *   **作为** 用户
    *   **我希望** 在选中文件后软件能在后台自动完成对比并保存记录
    *   **以便于** 我无需任何额外操作即可获得连续的对比日志
*   **业务规则与逻辑 (Business Logic)**:
    1.  **参数校验**: 启动时校验传入参数，必须且只能为 2 个文件路径。否则静默退出并弹错误通知。
    2.  **自动截断 (Auto-Truncation)**:
        *   读取文件内容，若单文件字符数 > 15,000 (可配置阈值)，则**保留头部**，截去尾部。
        *   若发生截断，在 Prompt 中自动注入提示：“*注意：输入内容过长，已自动截取前 XX% 进行对比。*”
    3.  **Prompt 组装**: 结合 System Prompt + 文件 A 内容 + 文件 B 内容。
    4.  **追加写入 (Append Mode)**:
        *   目标文件：原文件所在目录下的 `difference.md`。
        *   如果文件不存在则创建。
        *   写入格式：
            ```markdown
            
            ---
            ## 📅 对比报告: [File_A] vs [File_B]
            > 时间: YYYY-MM-DD HH:mm:ss | 状态: [完整 / 已截断]
            
            (AI 返回的内容)
            ```
*   **验收标准 (Acceptance Criteria)**:
    *   **场景1: 正常对比**
        *   **GIVEN** 选中2个短文本文件并点击右键
        *   **WHEN** 分析完成
        *   **THEN** `difference.md` 文件末尾新增了一段包含时间戳的对比结果。
    *   **场景2: 超长文件**
        *   **GIVEN** 选中2个超大文本文件
        *   **WHEN** 分析完成
        *   **THEN** 结果中明确标注“已截断”，且程序没有崩溃。

#### **US-04: 系统通知反馈 (Toast Notification)**
*   **价值陈述 (Value Statement)**:
    *   **作为** 用户
    *   **我希望** 收到明确的系统通知
    *   **以便于** 知道任务结果，并能快速打开报告文件
*   **业务规则与逻辑 (Business Logic)**:
    1.  **成功通知**:
        *   标题：“分析完成 (已追加)”
        *   内容：“结果已写入 difference.md”
        *   **点击行为**: 触发系统默认程序打开 `difference.md`。
    2.  **失败通知**: 显示具体错误（如 API 连接超时、文件数量错误）。

---

## 3. 技术实现概要 (Technical Implementation Brief)

*   **技术栈建议**:
    *   **Python (PyQt/Tkinter + PyInstaller)** 或 **C# (.NET 10 WPF/WinForms)**。
    *   需编译为独立的 `.exe` 可执行文件。
*   **系统集成 (Windows Integration)**:
    *   使用 Windows Registry API 操作 `HKEY_CURRENT_USER`。
    *   右键命令格式示例: `"C:\Path\To\App.exe" "%1"`。注意处理多文件参数传递问题（Windows 可能针对每个文件启动一次实例，需实现**单例模式/参数合并**逻辑，或通过父进程检测）。
*   **文件处理**:
    *   支持编码：优先 UTF-8，尝试自动检测 GBK/ASCII。
    *   格式支持：纯文本（.txt, .md, .cs, .js, .py, .json 等）。
*   **数据模型 / 存储**:
    *   `config.json`:
        ```json
        {
          "api": {
            "baseUrl": "...",
            "apiKey": "...",
            "model": "gpt-4o"
          },
          "prompts": {
            "system": "..."
          },
          "settings": {
            "maxTokenLimit": 15000
          }
        }
        ```

## 4. 约束与边界 (Constraints & Boundaries)

*   **性能约束**: 软件冷启动速度需 < 1秒（为了快速响应右键点击）。
*   **API 限制**: 依赖用户提供的 Key，受限于对应服务商的速率限制 (Rate Limit)。
*   **文件大小**: 暂不支持二进制文件（如 .doc, .pdf）的直接读取，仅支持文本流。

## 5. 开放问题与待确认事项 (Open Questions)

1.  **多实例并发问题**: 当用户选中 2 个文件时，Windows 可能会尝试启动两次程序。开发时需特别注意实现“互斥锁 (Mutex)”或参数聚合逻辑，确保只启动一个分析进程处理这两个文件。
2.  **富文本支持路线图**: 后续版本若支持 PDF/Word，需引入专门的解析库（如 `PyPDF2`, `python-docx`），这将显著增加软件体积。